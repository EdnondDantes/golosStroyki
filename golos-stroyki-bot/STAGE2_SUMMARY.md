# –≠—Ç–∞–ø 2 - –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

‚úÖ –°–æ–∑–¥–∞–Ω SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è `role` –≤ —Ç–∞–±–ª–∏—Ü—ã
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `checkUserRole()`
‚úÖ –°–æ–∑–¥–∞–Ω —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ —Å 6 –∫–Ω–æ–ø–∫–∞–º–∏
‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ñ–æ—Ä–º (contractors, orders, suppliers)

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í –ë–∞–∑—É"
         ‚Üì
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
         ‚Üì
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ –ë–î (checkUserRole)
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                   ‚îÇ
  –†–æ–ª—å –µ—Å—Ç—å        –†–æ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    ‚Üì                   ‚Üì
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é    –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
                         ‚Üì
                  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç
                         ‚Üì
              –†–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ userStates
                         ‚Üì
                  –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                         ‚Üì
         –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–Ω–∫–µ—Ç—ã/–∑–∞—è–≤–∫–∏
                         ‚Üì
              –†–æ–ª—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î
```

## üóÇÔ∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–æ–ª–∏

1. **üë∑ –†–∞–±–æ—á–∏–π** - –æ–±—ã—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã
2. **üëî –ë—Ä–∏–≥–∞–¥–∏—Ä** - —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –±—Ä–∏–≥–∞–¥—ã
3. **üè¢ –ü–æ–¥—Ä—è–¥—á–∏–∫ / –ö–æ–º–ø–∞–Ω–∏—è** - –ø–æ–¥—Ä—è–¥–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
4. **üíº –ó–∞–∫–∞–∑—á–∏–∫** - —á–µ–ª–æ–≤–µ–∫ —Å –æ–±—ä–µ–∫—Ç–æ–º
5. **üéì –≠–∫—Å–ø–µ—Ä—Ç** - —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
6. **üëÅ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å** - –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ–ª–µ `role`

–ü–æ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—ã:
- `contractors`
- `orders`
- `suppliers`

```sql
ALTER TABLE contractors ADD COLUMN role TEXT;
ALTER TABLE orders ADD COLUMN role TEXT;
ALTER TABLE suppliers ADD COLUMN role TEXT;
```

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_contractors_role ON contractors(role);
CREATE INDEX idx_orders_role ON orders(role);
CREATE INDEX idx_suppliers_role ON suppliers(role);
```

## üîë –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. checkUserRole(userId)

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ä–æ–ª–∏ –≤ –ë–î:
- –ò—â–µ—Ç –≤ `contractors`
- –ò—â–µ—Ç –≤ `orders`
- –ò—â–µ—Ç –≤ `suppliers`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–ª—å –∏–ª–∏ `null`

```javascript
const userRole = await checkUserRole(userId);
if (!userRole) {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
  await showRoleSelection(chatId);
}
```

### 2. showRoleSelection(chatId)

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω —Å 6 –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏

### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏

```javascript
if (data.startsWith('role_')) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–ª—å –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
  userStates[userId].selectedRole = selectedRole;
  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
  await showMainMenu(chatId);
}
```

### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤ –ë–î

–†–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–Ω–∫–µ—Ç—ã:

```javascript
// –í finishForm, finishOrderForm, finishSupplierForm
role: userData.selectedRole || null
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –†–æ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑

–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ–ª—å—à–µ –ù–ï —É–≤–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞, —Ç–∞–∫ –∫–∞–∫:
1. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ `checkUserRole()` –Ω–∞–π–¥–µ—Ç —Ä–æ–ª—å –≤ –ë–î
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø–æ–ø–∞–¥–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

### –†–æ–ª—å –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É

–†–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `userStates[userId].selectedRole` –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î —Ç–æ–ª—å–∫–æ –ø—Ä–∏:
- –°–æ–∑–¥–∞–Ω–∏–∏ –∞–Ω–∫–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- –°–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç
- –°–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞

### –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ä–æ–ª—å, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞–ª –∞–Ω–∫–µ—Ç—É

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –æ–Ω —Å–Ω–æ–≤–∞ —É–≤–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏, —Ç–∞–∫ –∫–∞–∫ –≤ –ë–î —Ä–æ–ª—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.

## üìù –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –í Supabase

–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∏–∑ `database-add-role.sql`:

```bash
# –û—Ç–∫—Ä—ã—Ç—å Supabase Dashboard
# SQL Editor ‚Üí New Query
# –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ database-add-role.sql
# Run
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

```bash
node bot.js
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–°–º. `STAGE2_CHECKLIST.md`

## üîÆ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–µ–π –≤ –±—É–¥—É—â–µ–º

–†–æ–ª—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è:

1. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é**
   - –†–∞–±–æ—á–µ–º—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ —Ä–∞–±–æ—Ç–µ
   - –ó–∞–∫–∞–∑—á–∏–∫—É - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞**
   - –ó–∞–∫–∞–∑—á–∏–∫–∞–º - —Ç–æ–ª—å–∫–æ –∞–Ω–∫–µ—Ç—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
   - –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º - —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã

3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**
   - –ö—Ç–æ —á–∞—â–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
   - –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ —Ä–æ–ª—è–º

4. **–î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º**
   - –≠–∫—Å–ø–µ—Ä—Ç–∞–º - –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º
   - –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

## üîó –°–≤—è–∑—å —Å –≠—Ç–∞–ø–æ–º 1

–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –≤—Å—Ç—Ä–æ–µ–Ω–∞ –ü–û–°–õ–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:

```
/start ‚Üí –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω ‚Üí "–í –ë–∞–∑—É" ‚Üí
  ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-01-XX
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –≠—Ç–∞–ø 3 (TBD)

-- ==================== МИГРАЦИЯ: Автоматическое истечение заявок ====================
--
-- Эта миграция создает CRON задачу для автоматического истечения заявок.
-- CRON запускается 1 раз в день (в 03:00) и меняет статус истекших заявок на 'expired'.
--
-- Статус: НОВОЕ - добавлено для автоматической очистки истекших заявок
-- Дата: 2025-12-24

-- ==================== ШАГ 1: Включить расширение pg_cron ====================

-- ВАЖНО: В Supabase pg_cron уже включен по умолчанию в большинстве случаев.
-- Если вы получаете ошибку "extension pg_cron does not exist", обратитесь в поддержку Supabase.

-- Проверить, что pg_cron доступен:
-- SELECT * FROM pg_extension WHERE extname = 'pg_cron';

-- ==================== ШАГ 2: Создать функцию истечения заявок ====================

CREATE OR REPLACE FUNCTION expire_old_orders()
RETURNS void AS $$
DECLARE
  updated_count INTEGER;
BEGIN
  -- Обновляем статус истекших заявок
  UPDATE orders
  SET status = 'expired'
  WHERE expires_at IS NOT NULL
    AND expires_at < NOW()
    AND status = 'approved';

  -- Получаем количество обновленных записей
  GET DIAGNOSTICS updated_count = ROW_COUNT;

  -- Логируем результат (можно посмотреть в Supabase Logs)
  RAISE NOTICE 'Expired % orders at %', updated_count, NOW();

END;
$$ LANGUAGE plpgsql;

-- ==================== ШАГ 3: Создать CRON задачу ====================

-- Удаляем старую задачу если она существует
SELECT cron.unschedule('expire-old-orders');

-- Создаем новую CRON задачу
-- Запускается каждый день в 03:00 (UTC timezone)
SELECT cron.schedule(
  'expire-old-orders',           -- Имя задачи
  '0 3 * * *',                   -- CRON расписание: каждый день в 03:00
  $$SELECT expire_old_orders();$$ -- SQL команда для выполнения
);

-- ==================== ПРИМЕЧАНИЯ ====================
--
-- 1. CRON расписание '0 3 * * *' означает:
--    - 0 минут
--    - 3 часа
--    - каждый день месяца (*)
--    - каждый месяц (*)
--    - каждый день недели (*)
--    = Каждый день в 03:00 UTC
--
-- 2. Временная зона: UTC (для России добавьте +3 часа от UTC)
--    Например, 03:00 UTC = 06:00 MSK (Москва)
--
-- 3. Если нужно изменить время запуска:
--    - '0 0 * * *'  -> каждый день в 00:00 (полночь)
--    - '0 6 * * *'  -> каждый день в 06:00
--    - '0 */6 * * *' -> каждые 6 часов
--    - '0 12 * * 1' -> каждый понедельник в 12:00
--
-- ==================== ПРОВЕРКА РАБОТЫ ====================
--
-- 1. Посмотреть все CRON задачи:
-- SELECT * FROM cron.job;
--
-- 2. Посмотреть историю выполнения:
-- SELECT * FROM cron.job_run_details
-- WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'expire-old-orders')
-- ORDER BY start_time DESC
-- LIMIT 10;
--
-- 3. Запустить вручную для теста:
-- SELECT expire_old_orders();
--
-- 4. Посмотреть истекшие заявки:
-- SELECT id, company_name, expires_at, status
-- FROM orders
-- WHERE status = 'expired';
--
-- ==================== УДАЛЕНИЕ (если нужно отключить) ====================
--
-- Удалить CRON задачу:
-- SELECT cron.unschedule('expire-old-orders');
--
-- Удалить функцию:
-- DROP FUNCTION IF EXISTS expire_old_orders();
--
-- ==================== КОММЕНТАРИИ ====================
--
-- Что происходит:
-- 1. Каждый день в 03:00 UTC запускается функция expire_old_orders()
-- 2. Функция находит все заявки (orders) где:
--    - expires_at IS NOT NULL (есть дата истечения)
--    - expires_at < NOW() (дата истечения прошла)
--    - status = 'approved' (заявка активна)
-- 3. Меняет статус на 'expired'
-- 4. Логирует количество обновленных записей
--
-- Почему это нужно:
-- - Истекшие заявки не показываются пользователям
-- - База данных остается чистой
-- - Счетчик "X из 2" обновляется корректно
-- - История сохраняется (заявки не удаляются, только меняется статус)

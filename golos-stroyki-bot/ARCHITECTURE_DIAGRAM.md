# Архитектурная диаграмма: Система хранения ролей

## 📊 Диаграмма базы данных

```
┌────────────────────────────────────────────────────────────────┐
│                      SUPABASE DATABASE                         │
└────────────────────────────────────────────────────────────────┘

┌─────────────────────────────┐
│    user_roles (НОВАЯ)       │  ← ГЛАВНАЯ таблица для ролей
├─────────────────────────────┤
│ id (SERIAL)                 │
│ telegram_id (BIGINT, UNIQUE)│  ← Primary key для быстрого поиска
│ role (VARCHAR)              │  ← Одна из 6 возможных ролей
│ created_at (TIMESTAMP)      │
│ updated_at (TIMESTAMP)      │
└─────────────────────────────┘
         ↑
         │ связь
         │
┌────────────────────────────────┐
│     contractors (СТАРАЯ)       │
├────────────────────────────────┤
│ id                             │
│ telegram_id                    │
│ role (VARCHAR) ← используется  │  ← Заполняется при создании анкеты
│ ... другие поля ...            │
└────────────────────────────────┘

┌────────────────────────────────┐
│     orders (СТАРАЯ)            │
├────────────────────────────────┤
│ id                             │
│ telegram_id                    │
│ role (VARCHAR) ← используется  │  ← Заполняется при создании заявки
│ ... другие поля ...            │
└────────────────────────────────┘

┌────────────────────────────────┐
│     suppliers (СТАРАЯ)         │  (если существует)
├────────────────────────────────┤
│ id                             │
│ telegram_id                    │
│ role (VARCHAR) ← используется  │
│ ... другие поля ...            │
└────────────────────────────────┘
```

## 🔄 Процесс выбора и использования роли

```
┌─────────────────────────────────────────────────────────────────┐
│              ПОЛЬЗОВАТЕЛЬ ЗАПУСКАЕТ БОТА (/start)               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ↓
        ┌──────────────────────────────────┐
        │  checkUserRole(userId)           │
        │  └─→ Поиск в user_roles таблице  │
        └──────┬───────────────────────────┘
               │
        ┌──────┴──────────┐
        │                 │
    Роль найдена?    Роль не найдена?
        │                 │
       ✅                 ❌
        │                 │
        ↓                 ↓
    ┌────────────┐   ┌──────────────────────┐
    │ Главное    │   │ Показать экран       │
    │ меню (БЕЗ  │   │ выбора роли          │
    │ переселекта│   └──────┬───────────────┘
    │ роли) ✅   │          │
    └────────────┘          ↓
                    ┌────────────────────┐
                    │ Пользователь       │
                    │ нажимает кнопку    │
                    │ с ролью            │
                    └─────┬──────────────┘
                          │
                          ↓
            ┌─────────────────────────────┐
            │  saveUserRole(userId, role) │
            │  └─→ Сохранить в user_roles │
            └─────────┬───────────────────┘
                      │
                      ↓
            ┌──────────────────────┐
            │ Роль сохранена в БД  │
            │ (НАВСЕГДА) ✅        │
            └──────────┬───────────┘
                       │
                       ↓
            ┌──────────────────────┐
            │ Показать главное     │
            │ меню (готово!)       │
            └──────────────────────┘
```

## 📝 Процесс создания анкеты

```
┌─────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ СОЗДАЕТ АНКЕТУ (contractor)           │
└──────────────────────────┬──────────────────────────┘
                           │
                           ↓
        ┌──────────────────────────────────┐
        │  Заполнить форму (11 шагов)      │
        │  - Формат работы                 │
        │  - Специализация                 │
        │  - Город                         │
        │  - Имя                           │
        │  - Опыт                          │
        │  - Объекты                       │
        │  - Преимущества                  │
        │  - Формат сотрудничества         │
        │  - Условия оплаты                │
        │  - Контакт                       │
        │  - Портфолио (фото)              │
        └──────────┬───────────────────────┘
                   │
                   ↓
        ┌──────────────────────────────┐
        │  finishForm(userId) НОВОЕ:   │
        │  └─→ checkUserRole(userId)   │  ← Получить роль из БД
        │      ↓                        │
        │      role: user_roles        │
        └──────┬───────────────────────┘
               │
               ↓
    ┌────────────────────────────────┐
    │ saveContractorToDatabase()      │
    │ └─→ Сохранить анкету с ролью   │
    └────┬─────────────────────────────┘
         │
         ↓
    ┌────────────────────────────┐
    │ contractors таблица:        │
    │ ├─ id                       │
    │ ├─ telegram_id              │
    │ ├─ name                     │
    │ ├─ specialization           │
    │ ├─ city                     │
    │ ├─ category (AI)            │
    │ ├─ role ← ЗАПОЛНЕН ✅       │
    │ └─ ... другие поля ...      │
    └────────────────────────────┘
```

## 🔍 Поиск роли: БЫЛО vs СТАЛО

### БЫЛО (Старая система)
```
checkUserRole(userId):
    │
    ├─→ Проверить contractors (запрос 1)
    │   └─→ Нет? ↓
    │
    ├─→ Проверить orders (запрос 2)
    │   └─→ Нет? ↓
    │
    ├─→ Проверить suppliers (запрос 3)
    │   └─→ Нет? ↓
    │
    └─→ Вернуть null ❌

    РЕЗУЛЬТАТ: 3 запроса, медленнее, роль может быть в разных таблицах
```

### СТАЛО (Новая система)
```
checkUserRole(userId):
    │
    └─→ Проверить user_roles (запрос 1)
        ├─→ Найдена? ✅ Вернуть роль
        └─→ Нет? Вернуть null

    РЕЗУЛЬТАТ: 1 запрос, быстрее, роль в одном месте
```

## 🗂️ Структура проекта: изменения

```
golos-stroyki-bot/
│
├── bot.js (ОБНОВЛЕН) ⭐
│   ├── checkUserRole() - обновлена (строка 741)
│   ├── saveUserRole() - НОВАЯ (строка 780)
│   ├── callback role_ - обновлена (строка 1325)
│   ├── finishForm() - обновлена (строка 3303)
│   └── finishOrderForm() - обновлена (строка 3358)
│
├── migrations_user_roles.sql (НОВЫЙ) ⭐
│   └── CREATE TABLE user_roles
│       └── Индекс на telegram_id
│       └── Триггер для updated_at
│
├── USER_ROLES_IMPLEMENTATION.md (НОВЫЙ) 📖
│   └── Полная документация
│
├── ROLE_IMPLEMENTATION_CHECKLIST.md (НОВЫЙ) 📋
│   └── Пошаговый чек-лист
│
├── CHANGES_SUMMARY.md (НОВЫЙ) 📝
│   └── Краткое резюме
│
└── ARCHITECTURE_DIAGRAM.md (НОВЫЙ) 📊
    └── Эта диаграмма
```

## 🔐 Безопасность

```
Таблица user_roles:
┌─────────────────────────────────────┐
│ Защита 1: UNIQUE constraint         │
│ └─→ telegram_id уникален            │
│    └─→ Один пользователь = одна роль│
│                                     │
│ Защита 2: CHECK constraint          │
│ └─→ role может быть только:         │
│    - 'рабочий'                      │
│    - 'бригадир'                     │
│    - 'подрядчик/компания'           │
│    - 'заказчик'                     │
│    - 'эксперт'                      │
│    - 'наблюдатель'                  │
│    └─→ Невозможно сохранить         │
│        неправильную роль            │
│                                     │
│ Защита 3: Индекс на telegram_id     │
│ └─→ Быстрый поиск                   │
│    └─→ Сложно перегрузить сервер    │
│                                     │
│ Защита 4: Триггер для updated_at    │
│ └─→ Всегда знаем когда была         │
│    обновлена роль                   │
└─────────────────────────────────────┘
```

## 📊 Примеры запросов

```sql
-- Получить роль пользователя
SELECT role FROM user_roles
WHERE telegram_id = 123456789;

-- Обновить роль
UPDATE user_roles
SET role = 'заказчик'
WHERE telegram_id = 123456789;

-- Удалить роль (пользователь выберет заново при следующем входе)
DELETE FROM user_roles
WHERE telegram_id = 123456789;

-- Статистика по ролям
SELECT role, COUNT(*) as count
FROM user_roles
GROUP BY role
ORDER BY count DESC;

-- Найти все пользователей с определенной ролью
SELECT telegram_id
FROM user_roles
WHERE role = 'подрядчик/компания';
```

## 🎯 Потоки данных

### Поток 1: Первый выбор роли
```
Telegram сообщение → bot.js → saveUserRole() → Supabase user_roles
                                                      ↓
                                             Роль сохранена ✅
```

### Поток 2: Следующий вход
```
Telegram сообщение → bot.js → checkUserRole() → Supabase user_roles
                                                      ↓
                                                  Роль найдена ✅
```

### Поток 3: Создание анкеты
```
Telegram сообщение → bot.js → finishForm() → checkUserRole()
                                                   ↓
                                           Supabase user_roles
                                                   ↓
                                            Роль получена ✅
                                                   ↓
                                           saveContractorToDatabase()
                                                   ↓
                                            Contractors таблица
```

## 🚀 Производительность

```
Операция                        Было              Стало
──────────────────────────────────────────────────────────
Поиск роли при входе           3 запроса (slow)  1 запрос (fast) ✅
Сохранение роли                При создании      Сразу ✅
                               анкеты
Хранение роли в памяти         Да (потеря)       Нет (в БД) ✅
Миграция при перезапуске       3 проверки        1 проверка ✅
Индекс для поиска              Нет (full scan)   Да (быстро) ✅
```

## 📈 Масштабируемость

Текущая архитектура легко масштабируется для:

```
├─ Смена роли пользователем
│  └─→ UPDATE user_roles WHERE telegram_id = ...
│
├─ Статистика по ролям
│  └─→ GROUP BY role COUNT(*)
│
├─ История изменения ролей
│  └─→ Добавить таблицу user_role_history
│
├─ Администраторские команды
│  └─→ /admin_set_role <telegram_id> <role>
│
└─ Аналитика пользователей
   └─→ JOIN user_roles WITH contractors/orders
```

---

**Диаграмма создана:** 2025-12-24
**Версия:** 1.0
**Статус:** Готово к использованию

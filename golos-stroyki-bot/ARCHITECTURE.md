# 📊 СХЕМА РАБОТЫ БОТА

## 🔄 ПОЛНЫЙ FLOW ПОЛЬЗОВАТЕЛЯ

```
┌─────────────────────────────────────────────────────────────────┐
│                       СТАРТ БОТА                                │
│                    Команда /start                               │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
        ┌────────────────┐
        │ Проверка       │
        │ подписки       │
        └───┬────────┬───┘
            │        │
    НЕТ ◄───┘        └───► ДА
     │                      │
     ▼                      ▼
┌─────────────┐      ┌─────────────┐
│ Просьба     │      │ Главное     │
│ подписаться │      │ меню        │
└──────┬──────┘      └──────┬──────┘
       │                    │
       │  Кнопка "Я         │
       │  подписался"       │
       └────────┬───────────┘
                │
                ▼
        ┌────────────────┐
        │ Повторная      │
        │ проверка       │
        └───┬────────┬───┘
            │        │
    НЕТ ◄───┘        └───► ДА
     │                      │
     ▼                      ▼
┌─────────────┐      ┌──────────────────┐
│ Сообщение   │      │ ГЛАВНОЕ МЕНЮ     │
│ об ошибке   │      │                  │
└─────────────┘      │ 🔍 Найти         │
                     │ ➕ Добавить      │
                     │ ⭕️ Жалоба       │
                     │ ❓ FAQ           │
                     │ 💬 Сообщество    │
                     └────────┬─────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
      ┌───────────┐   ┌───────────┐   ┌───────────┐
      │ Найти     │   │ Добавить  │   │ Другие    │
      │ (TODO)    │   │ анкету    │   │ функции   │
      └───────────┘   └─────┬─────┘   └───────────┘
                            │
                            ▼
```

---

## 📝 ПРОЦЕСС ЗАПОЛНЕНИЯ АНКЕТЫ

```
                    ┌────────────────────┐
                    │ Кнопка "Добавить   │
                    │ себя в каталог"    │
                    └──────────┬─────────┘
                               │
                               ▼
                    ┌────────────────────┐
                    │ Подтверждение:     │
                    │ "Начнём?"          │
                    │                    │
                    │ [✅ Да] [❌ Нет]  │
                    └──┬──────────────┬──┘
                       │              │
            ДА ◄───────┘              └───────► НЕТ
             │                                   │
             ▼                                   ▼
    ┌──────────────────┐                ┌──────────────┐
    │ ШАГ 1/8          │                │ Возврат в    │
    │ Имя/компания     │                │ главное меню │
    │                  │                └──────────────┘
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 2/8          │
    │ Город            │
    │                  │
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 3/8          │
    │ Специализация    │
    │                  │
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 4/8          │
    │ Опыт работы      │
    │                  │
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 5/8          │
    │ Описание         │
    │                  │
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 6/8          │
    │ Цены             │
    │                  │
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 7/8          │
    │ Портфолио        │
    │                  │
    │ 📝 Ссылка        │
    │ или "нет"        │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ ШАГ 8/8          │
    │ Контакты         │
    │                  │
    │ 📝 Текст         │
    │ 🎤 Голос         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ Сохранение в     │
    │ Supabase         │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ 🎉 Успех!        │
    │ Анкета на        │
    │ модерации        │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ Возврат в        │
    │ главное меню     │
    └──────────────────┘
```

---

## 🔊 ОБРАБОТКА ГОЛОСОВЫХ СООБЩЕНИЙ

```
    ┌─────────────────────┐
    │ Пользователь        │
    │ отправляет голос    │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ Бот скачивает       │
    │ аудио файл (.ogg)   │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ Отправка в          │
    │ Yandex SpeechKit    │
    └──────┬──────────┬───┘
           │          │
   УСПЕХ ◄─┘          └─► ОШИБКА
     │                      │
     ▼                      ▼
┌──────────────┐    ┌──────────────┐
│ Получен текст│    │ Просьба      │
│              │    │ повторить    │
│ ✅ Записано: │    │ или отправить│
│ "5 лет"      │    │ текстом      │
└──────┬───────┘    └──────────────┘
       │
       ▼
┌──────────────┐
│ Сохранение   │
│ в состояние  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ Переход к    │
│ след. шагу   │
└──────────────┘
```

---

## 💾 РАБОТА С БАЗОЙ ДАННЫХ

```
    ┌──────────────────────┐
    │ Заполнена вся анкета │
    │ (все 8 шагов)        │
    └───────────┬──────────┘
                │
                ▼
    ┌──────────────────────┐
    │ Получение данных     │
    │ из FSM State         │
    └───────────┬──────────┘
                │
                ▼
    ┌──────────────────────┐
    │ Формирование         │
    │ объекта для          │
    │ Supabase:            │
    │                      │
    │ {                    │
    │   user_id: 123,      │
    │   name: "Иван",      │
    │   city: "Москва",    │
    │   ...                │
    │   status: "mod..."   │
    │ }                    │
    └───────────┬──────────┘
                │
                ▼
    ┌──────────────────────┐
    │ INSERT в таблицу     │
    │ contractors          │
    └────┬──────────────┬──┘
         │              │
  УСПЕХ ◄┘              └► ОШИБКА
    │                       │
    ▼                       ▼
┌────────────┐      ┌────────────┐
│ Уведомление│      │ Сообщение  │
│ об успехе  │      │ об ошибке  │
│            │      │            │
│ 🎉 Отлично!│      │ ❌ Ошибка  │
│ На мод...  │      │ Попробуй   │
└──────┬─────┘      │ позже      │
       │            └────────────┘
       ▼
┌────────────┐
│ Очистка    │
│ состояния  │
│ FSM        │
└──────┬─────┘
       │
       ▼
┌────────────┐
│ Возврат в  │
│ главное    │
│ меню       │
└────────────┘
```

---

## 🔐 ПРОВЕРКА ПОДПИСКИ

```
    ┌──────────────────┐
    │ Пользователь     │
    │ отправил /start  │
    └────────┬─────────┘
             │
             ▼
    ┌─────────────────────────────┐
    │ bot.get_chat_member()        │
    │ Проверка статуса в канале   │
    └─────┬───────────────────┬───┘
          │                   │
  ПОДПИСАН│                   │НЕ ПОДПИСАН
          ▼                   ▼
    ┌──────────┐       ┌──────────────┐
    │ Главное  │       │ Сообщение с  │
    │ меню     │       │ просьбой     │
    │          │       │ подписаться  │
    │ 🔍 Найти │       │              │
    │ ➕ Добав.│       │ Кнопки:      │
    │ ...      │       │ [Подписаться]│
    └──────────┘       │ [✅ Готово]  │
                       └──────┬───────┘
                              │
                Нажата кнопка "Готово"
                              │
                              ▼
                       ┌──────────────┐
                       │ Повторная    │
                       │ проверка     │
                       └──┬────────┬──┘
                          │        │
                   ДА ◄───┘        └───► НЕТ
                    │                    │
                    ▼                    ▼
              ┌──────────┐         ┌──────────┐
              │ Главное  │         │ Уведом-  │
              │ меню     │         │ ление:   │
              └──────────┘         │ "Ещё не  │
                                   │ подписан"│
                                   └──────────┘
```

---

## 📊 СТАТУСЫ АНКЕТ В БД

```
    ┌──────────────────────┐
    │ Новая анкета         │
    │ status = "moderation"│
    └───────────┬──────────┘
                │
    ┌───────────┴───────────┐
    │                       │
    ▼                       ▼
┌──────────┐         ┌──────────┐
│ Админ    │         │ Админ    │
│ одобрил  │         │ отклонил │
└────┬─────┘         └────┬─────┘
     │                    │
     ▼                    ▼
┌──────────┐         ┌──────────┐
│ status = │         │ status = │
│"approved"│         │"rejected"│
└────┬─────┘         └────┬─────┘
     │                    │
     ▼                    ▼
┌──────────┐         ┌──────────┐
│ Видна в  │         │ Не видна │
│ каталоге │         │ в поиске │
└──────────┘         └──────────┘
```

---

## 🎯 FSM (МАШИНА СОСТОЯНИЙ)

```
┌─────────────────────────────────────────────────┐
│                FSM STATES                       │
├─────────────────────────────────────────────────┤
│                                                 │
│  waiting_for_subscription                       │
│          │                                      │
│          ▼                                      │
│  [Главное меню - без состояния]                │
│          │                                      │
│   Выбрал "Добавить"                             │
│          │                                      │
│          ▼                                      │
│  ContractorForm.name ──────► (Сохранение)      │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.city ──────► (Сохранение)      │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.specialization ► (Сохранение)  │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.experience ─────► (Сохранение) │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.description ────► (Сохранение) │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.price ──────────► (Сохранение) │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.portfolio ──────► (Сохранение) │
│          │                        │             │
│          ▼                        ▼             │
│  ContractorForm.contacts ───────► (Сохранение) │
│          │                        │             │
│          ▼                        ▼             │
│  [Финализация] ─────────► INSERT в Supabase    │
│          │                                      │
│          ▼                                      │
│  state.clear() ──► [Главное меню]              │
│                                                 │
└─────────────────────────────────────────────────┘

На любом этапе:
[Кнопка "Назад"] ──► state.clear() ──► [Главное меню]
```

---

## 🔄 ЖИЗНЕННЫЙ ЦИКЛ ЗАПРОСА

```
1. Пользователь → Telegram серверы
           ↓
2. Telegram серверы → Webhook/Polling → Ваш бот
           ↓
3. Aiogram Router → Обработчик (handler)
           ↓
4. Обработчик обращается к:
   • FSM (состояние пользователя)
   • Supabase (база данных)
   • Yandex API (распознавание голоса)
           ↓
5. Формирование ответа
           ↓
6. Отправка через Telegram API
           ↓
7. Пользователь видит ответ
```

---

## 📱 СТРУКТУРА СООБЩЕНИЙ

```
┌────────────────────────────────────┐
│ 👋 <b>Привет!</b>                  │  ← HTML форматирование
│                                    │
│ Ты в <i>Каталоге</i>               │  ← Курсив
│                                    │
│ Здесь ты можешь:                   │
│ 🔹 найти подрядчика                │  ← Эмодзи
│ 🔹 добавить себя                   │
│                                    │
│ <b>Выбери что нужно 👇</b>         │  ← Жирный
│                                    │
├────────────────────────────────────┤
│ [🔍 Найти подрядчика         ]    │  ← Inline кнопки
│ [➕ Добавить себя            ]    │
│ [⭕️ Отправить жалобу         ]    │
│ [❓ FAQ / Помощь             ]    │
│ [💬 Сообщество               ]    │
└────────────────────────────────────┘
```

---

**Эта схема поможет вам понять логику работы бота! 🎯**
